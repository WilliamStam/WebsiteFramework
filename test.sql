SELECT as_adverts.*, as_categories.width, as_categories.height, as_adverts_domains.ID AS recordID, as_adverts_domains.impressions, as_adverts_domains.impressionsRawCount, as_adverts_domains.clicks, as_adverts_domains.clicksRawCount, (if((as_adverts_domains.impressionsUsed + as_adverts_domains.clicksUsed) + (COALESCE(as_domain_category_rate.impressionRate/1000, as_categories.defaultRate/1000) + COALESCE(as_domain_category_rate.clickRate/1000, as_categories.defaultClickRate/1000)) >= as_adverts_domains.budget,''0'',''1'' )) AS active, format((as_adverts_domains.impressionsUsed + as_adverts_domains.clicksUsed),2) AS used, (((as_adverts_domains.impressionsUsed + as_adverts_domains.clicksUsed)/budget)*100) AS percentused, COALESCE(as_domain_category_rate.impressionRate, as_categories.defaultRate) AS impressionRate, COALESCE(as_domain_category_rate.clickRate, as_categories.defaultClickRate) AS clickRate FROM (((as_adverts INNER JOIN as_campaigns ON as_adverts.campaignID = as_campaigns.ID) INNER JOIN as_categories ON as_adverts.categoryID = as_categories.ID) INNER JOIN as_adverts_domains ON as_adverts.ID = as_adverts_domains.aID) INNER JOIN as_domain_category_rate ON (as_categories.ID = as_domain_category_rate.categoryID) AND (as_adverts_domains.dID = as_domain_category_rate.domainID) WHERE (if((as_adverts_domains.impressionsUsed + as_adverts_domains.clicksUsed) + (COALESCE(as_domain_category_rate.impressionRate/1000, as_categories.defaultRate/1000) + COALESCE(as_domain_category_rate.clickRate/1000, as_categories.defaultClickRate/1000)) >= as_adverts_domains.budget,''0'',''1'' )) = 1 AND as_domain_category_rate.domainID = ''15'' AND as_adverts_domains.dID =''15'' AND categoryID = ''15'' AND (dateFrom <= CURRENT_DATE() AND dateTO >= CURRENT_DATE()) ; 